define(["jquery","theme_remui/Chart","theme_remui/select2","jqueryui","theme_remui/app"],function(a,b,c,d,e){return{initialise:function(c){function d(){null!==h&&h.destroy();var c=a("#pieChart").get(0).getContext("2d");h=new b(c).Doughnut(g,m)}function e(){var b=a("#coursecategorylist option:selected").data("id");a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/rest.php?action=get_courses_by_category&categoryid="+b,success:function(b){if(void 0===b[0])a("canvas#pieChart").hide(),a(".enroll-stats-nouserserror").hide(),a(".chart-legend").hide(),a(".enroll-stats-error").show();else if(0===b.totalusercount)a("canvas#pieChart").hide(),a(".enroll-stats-error").hide(),a(".chart-legend").hide(),a(".enroll-stats-nouserserror").show();else{a(".enroll-stats-error").hide(),a(".enroll-stats-nouserserror").hide(),a(".chart-legend").show(),a("canvas#pieChart").show();var c=[],e=["#2196f3","#00bcd4","#009688","#4caf50","#8bc34a","#ffeb3b","#ff9800","#f44336","#9c27b0","#673ab7","#3f51b5"],f=0;if(a("#enrolled_users_stats .chart-legend").empty(),b.length>11){for(var h=0,i=10;i<b.length;i++)h+=b[i].count;b.splice(11,b.length-1),b[10].shortname="Other Courses",b[10].fullname="Other Courses",b[10].count=h}a.each(b,function(b,d){a("#enrolled_users_stats .chart-legend").append('<li><i class="fa fa-circle-o" style="color: '+e[f]+'"></i> '+d.shortname+"</li>"),c.push({value:d.count,color:e[f],highlight:e[f],label:d.shortname}),f++}),g=c,d()}},error:function(b,c,d){a("canvas#pieChart").hide(),a(".enroll-stats-error").show()}})}function f(){var c=a("#quiz-course-list option:selected").data("id");a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/rest.php?action=get_courses_for_quiz&courseid="+c,success:function(c){if(void 0===c.datasets)a("div#quiz-chart-area").hide(),a(".quiz-stats-error").show();else{var d=a("#barChart").get(0).getContext("2d");null!==i&&i.destroy(),i=new b(d).Bar(c,{responsive:!0,maintainAspectRatio:!0})}},error:function(b,c,d){a("div#quiz-chart-area").hide(),a(".quiz-stats-error").show()}})}var g={},h=null,i=null,j='<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%>',k='<span style="background-color:<%=segments[i].fillColor%>"></span>',l="<%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>",m={segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:1,percentageInnerCutout:50,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:!0,animateScale:!1,responsive:!0,maintainAspectRatio:!0,legendTemplate:j+k+l,tooltipTemplate:"<%=value %> <%=label%> users"};if(a("#enrolled_users_stats select").length&&(a("#enrolled_users_stats select#coursecategorylist").on("change",function(){e()}),e()),a("#barChart").length&&(a("#quiz_stats select#quiz-course-list").on("change",function(){f()}),f()),a("#col7,#col5").sortable({placeholder:"sort-highlight",connectWith:"#col5,#col7",handle:".box-header, .nav-tabs",forcePlaceholderSize:!0,zIndex:999999,items:"> div",stop:function(){var b=a("#col7").sortable("toArray"),c=a("#col5").sortable("toArray");M.util.set_user_preference("layout_7",JSON.stringify(b)),M.util.set_user_preference("layout_5",JSON.stringify(c)),a("#col7").prepend(a("#default_layout7_element")),a("#col5").prepend(a("#default_layout5_element"))}}),a("#col7 > * , #col5 > *").css("cursor","move"),a(".todo-list").sortable({placeholder:"sort-highlight",handle:".handle",forcePlaceholderSize:!0,zIndex:999999}),a("div#quick_message select#id_comboboxcontacts").length&&(a("div#quick_message div#fitem_id_comboboxcontacts div.fitemtitle").remove(),a("#id_submitbutton").click(function(b){b.preventDefault(),a("#message").removeClass("alert-success").addClass("alert-info").html(M.util.get_string("sendingmessage","theme_remui")).show();var d=a("#id_user").val(),e=a("#id_comboboxcontacts").val(),f=a.trim(a("#id_messagebody").val()),g="quickmessage";return"0"===e?(a("#message").removeClass("alert-info").addClass("alert-warning").html(M.util.get_string("selectcontact","theme_remui")).show(),!1):(""===f?a("#message").removeClass("alert-info").addClass("alert-warning").html(M.util.get_string("entermessage","theme_remui")).show():a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/rest.php?action=send_"+g+"&contactid="+e+"&message="+f+"&contextid="+c,success:function(b){"success"===a.trim(b.html)?(a("#id_messagebody").val(""),a("#id_messagebody").attr("placeholder",M.util.get_string("sendmoremessage","theme_remui")),a("#message").removeClass().addClass("alert alert-success").html(M.util.get_string("messagesent","theme_remui")+"<a class='pull-right' style='text-decoration: none; font-weight:bold;' target='_blank' href='"+M.cfg.wwwroot+"/message/index.php?user1="+d+"&user2="+e+"'>View conversation</a>").show()):a("#message").removeClass().addClass("alert alert-danger").html(M.util.get_string("messagenotsent","theme_remui")).show()},error:function(b,c,d){a("#message").removeClass().addClass("alert-danger").html(M.util.get_string("messagenotsenterror","theme_remui")+" <br />"+d).show()}}),!1)})),a(".add-notes-select").length){a(".add-notes-select select").select2(),a(".add-notes-select select option:first-child").attr("disabled",!0);var n,o,p,q;a(".add-notes-select select").on("change",function(){if(a(".add-notes-button a").hide(),n=a(this).children(":selected").attr("id"),q=a(this).children(":selected").text(),void 0===n)return a(".select2-studentlist").empty(),void a(".select2-studentlist").select2({placeholder:{id:"-1",text:M.util.get_string("selectcoursetodisplayusers","theme_remui")}});var b="userlist";a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/rest.php?action=get_"+b+"&courseid="+n,success:function(b){o=Object.keys(b).length,a(".select2-studentlist").empty(),o?(a(".select2-studentlist").append("<option>"+M.util.get_string("selectastudent","theme_remui")+" ("+M.util.get_string("total","theme_remui")+": "+o+")</option>"),a(".select2-studentlist").select2({placeholder:{id:"-1",text:M.util.get_string("selectastudent","theme_remui")+" ("+M.util.get_string("total","theme_remui")+": "+o+")"}})):(a(".select2-studentlist").append(M.util.get_string("nousersenrolledincourse","theme_remui",q)),a(".select2-studentlist").select2({placeholder:{id:"-1",text:M.util.get_string("nousersenrolledincourse","theme_remui",q)}})),a.each(b,function(b,c){a(".select2-studentlist").append('<option value="'+b+'">'+c.firstname+" "+c.lastname+"</option>")}),b=""},error:function(b,c,d){a(".select2-studentlist").html("<option>"+d+"</option>")}})}),a(".select2-studentlist").select2({placeholder:{id:"-1",text:M.util.get_string("selectcoursetodisplayusers","theme_remui")}}),a(".select2-studentlist").on("change",function(){a(".add-notes-button a").show(),p=a(".select2-studentlist").select2("data")[0].id;var b=M.cfg.wwwroot+"/notes/edit.php?courseid="+n+"&userid="+p+"&publishstate=site";a(".add-notes-button .site-note").attr("href",b),b=M.cfg.wwwroot+"/notes/edit.php?courseid="+n+"&userid="+p+"&publishstate=public",a(".add-notes-button .course-note").attr("href",b),b=M.cfg.wwwroot+"/notes/edit.php?courseid="+n+"&userid="+p+"&publishstate=draft",a(".add-notes-button .personal-note").attr("href",b)})}a('[aria-selected="false"]').attr("aria-selected","true")}}});